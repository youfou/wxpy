#!/usr/bin/env python3
# coding: utf-8

from binascii import crc32
from threading import Thread

from wxpy.api.chats import FEMALE, MALE

emojis = \
    'ğŸ˜ƒğŸ»ğŸ”âš½ğŸŒ‡ğŸ’¡ğŸ”£ğŸŒğŸ’ŒğŸ™ˆğŸ™‰ğŸ™ŠğŸ’¥ğŸ’¦ğŸ’¨ğŸ’«ğŸµğŸ’ğŸ¦ğŸ¶ğŸ•ğŸ©ğŸºğŸ¦ŠğŸ±ğŸˆğŸ¦ğŸ¯ğŸ…ğŸ†ğŸ´ğŸğŸ¦„ğŸ®ğŸ‚ğŸƒğŸ„ğŸ·ğŸ–ğŸ—' \
    'ğŸ½ğŸğŸ‘ğŸğŸªğŸ«ğŸ˜ğŸ¦ğŸ­ğŸğŸ€ğŸ¹ğŸ°ğŸ‡ğŸ¿ğŸ¦‡ğŸ¨ğŸ¼ğŸ¾ğŸ¦ƒğŸ”ğŸ“ğŸ£ğŸ¤ğŸ¥ğŸ¦ğŸ§ğŸ•ŠğŸ¦…ğŸ¦†ğŸ¦‰ğŸ¸ğŸŠğŸ¢ğŸ¦ğŸğŸ²ğŸ‰ğŸ³ğŸ‹' \
    'ğŸ¬ğŸŸğŸ ğŸ¡ğŸ™ğŸšğŸ¦€ğŸ¦ğŸ¦‘ğŸŒğŸ¦‹ğŸ›ğŸœğŸğŸğŸ•·ğŸ•¸ğŸ¦‚ğŸ’ğŸŒ¸ğŸ’®ğŸµğŸŒ¹ğŸ¥€ğŸŒºğŸŒ»ğŸŒ¼ğŸŒ·ğŸŒ±ğŸŒ²ğŸŒ³ğŸŒ´ğŸŒµğŸŒ¾ğŸŒ¿â˜˜ğŸ€ğŸğŸ‚ğŸƒ' \
    'ğŸ„ğŸŒ°ğŸŒğŸŒğŸŒğŸŒğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜ğŸŒ™ğŸŒšğŸŒ›ğŸŒœâ˜€ğŸŒğŸŒâ­ğŸŒŸğŸŒ â˜â›…â›ˆğŸŒ¤ğŸŒ¥ğŸŒ¦ğŸŒ§ğŸŒ¨ğŸŒ©ğŸŒªğŸŒ«ğŸŒ¬ğŸŒˆâ˜‚â˜”âš¡' \
    'â„â˜ƒâ›„â˜„ğŸ”¥ğŸ’§ğŸŒŠğŸ„âœ¨ğŸ‹ğŸğŸ¤·ğŸ˜‚â¤ğŸ˜ğŸ˜ŠğŸ¤”ğŸ˜˜ğŸ™„ğŸ“²ğŸš»ğŸ‘€ğŸ’»âœŠğŸ“ğŸ‡ğŸ‚ğŸ›ğŸ…ğŸ¥ğŸ‘¨ğŸ’ªğŸ“ğŸƒğŸ•ğŸ•‰ğŸ‘©ğŸŠğŸŠğŸ‘‘' \
    'â˜ªğŸˆğŸ’˜ğŸ‘°ğŸ¿ğŸ‡ğŸˆğŸ‰ğŸŠğŸ‹ğŸŒğŸğŸğŸğŸğŸ‘ğŸ’ğŸ“ğŸ¥ğŸ…ğŸ¥‘ğŸ†ğŸ¥”ğŸ¥•ğŸŒ½ğŸŒ¶ğŸ¥’ğŸ¥œğŸğŸ¥ğŸ¥–ğŸ¥ğŸ§€ğŸ–ğŸ—ğŸ¥“ğŸŸğŸ•ğŸŒ­ğŸŒ®' \
    'ğŸŒ¯ğŸ³ğŸ²ğŸ¥—ğŸ¿ğŸ±ğŸ˜ğŸ™ğŸšğŸ›ğŸœğŸğŸ ğŸ¢ğŸ£ğŸ¤ğŸ¥ğŸ¡ğŸ¦ğŸ§ğŸ¨ğŸ©ğŸªğŸ°ğŸ«ğŸ¬ğŸ­ğŸ®ğŸ¯ğŸ¼ğŸ¥›â˜•ğŸµğŸ¶ğŸ¾ğŸ·ğŸ¸ğŸ¹ğŸºğŸ»' \
    'ğŸ¥‚ğŸ¥ƒğŸ½ğŸ´ğŸ¥„ğŸ‘¾ğŸ•´ğŸ‡â›·ğŸ‚ğŸŒğŸ„ğŸš£â›¹ğŸ‹ğŸš´ğŸšµğŸ¤¸ğŸ¤¼ğŸ¤½ğŸ¤¾ğŸ¤¹ğŸªğŸ­ğŸ¨ğŸ°ğŸ—ğŸŸğŸ«ğŸ–ğŸ†ğŸ…ğŸ¥‡ğŸ¥ˆğŸ¥‰âš¾ğŸ€ğŸğŸ‰ğŸ¾' \
    'ğŸ±ğŸ³ğŸğŸ‘ğŸ’ğŸ“ğŸ¸ğŸ¥ŠğŸ¥‹ğŸ¯â›³â›¸ğŸ£ğŸ½ğŸ®ğŸ²ğŸ¼ğŸ¤ğŸ§ğŸ·ğŸ¸ğŸ¹ğŸºğŸ»ğŸ¥ğŸ¬ğŸ¹ğŸğŸğŸ—¾ğŸ”â›°ğŸŒ‹ğŸ—»ğŸ•ğŸ–ğŸœğŸğŸğŸŸ' \
    'ğŸ›ğŸ—ğŸ˜ğŸ™ğŸšğŸ ğŸ¡ğŸ¢ğŸ£ğŸ¤ğŸ¥ğŸ¦ğŸ¨ğŸ©ğŸªğŸ«ğŸ¬ğŸ­ğŸ¯ğŸ°ğŸ’’ğŸ—¼ğŸ—½â›ªğŸ•ŒğŸ•â›©ğŸ•‹â›²â›ºğŸŒğŸŒƒğŸŒ„ğŸŒ…ğŸŒ†ğŸŒ‰ğŸŒŒğŸ ğŸ¡ğŸ¢' \
    'ğŸš‚ğŸšƒğŸš„ğŸš…ğŸš†ğŸš‡ğŸšˆğŸš‰ğŸšŠğŸšğŸšğŸš‹ğŸšŒğŸšğŸšğŸšğŸš‘ğŸš’ğŸš“ğŸš”ğŸš•ğŸš–ğŸš—ğŸš˜ğŸššğŸš›ğŸšœğŸš²ğŸ›´ğŸ›µğŸšğŸ›¤â›½ğŸš¨ğŸš¥ğŸš¦ğŸš§âš“â›µğŸš¤' \
    'ğŸ›³â›´ğŸ›¥ğŸš¢âœˆğŸ›©ğŸ›«ğŸ›¬ğŸ’ºğŸšğŸšŸğŸš ğŸš¡ğŸ›°ğŸš€â›±ğŸ†ğŸ‘ğŸ’´ğŸ’µğŸ’¶ğŸ’·ğŸ—¿ğŸ›‚ğŸ›ƒğŸ›„ğŸ›…â˜ ğŸ›€ğŸ›ŒğŸ’£ğŸ•³ğŸ“¿ğŸ’ğŸ”ªğŸºğŸ—ºğŸ’ˆğŸ–¼ğŸ›' \
    'ğŸšªğŸ›ğŸ›‹ğŸš½ğŸš¿ğŸ›âŒ›â³âŒšâ°â±â²ğŸ•°ğŸŒ¡ğŸˆğŸ‰ğŸğŸğŸğŸ€ğŸğŸ•¹ğŸ“¯ğŸ™ğŸšğŸ›ğŸ“»ğŸ“±â˜ğŸ“ğŸ“ŸğŸ“ ğŸ”‹ğŸ”ŒğŸ–¥ğŸ–¨âŒ¨ğŸ–±ğŸ–²ğŸ’½' \
    'ğŸ’¾ğŸ’¿ğŸ“€ğŸğŸ“½ğŸ“ºğŸ“·ğŸ“¸ğŸ“¹ğŸ“¼ğŸ”ğŸ”ğŸ”¬ğŸ”­ğŸ“¡ğŸ•¯ğŸ”¦ğŸ®ğŸ“”ğŸ“•ğŸ“–ğŸ“—ğŸ“˜ğŸ“™ğŸ“šğŸ““ğŸ“ƒğŸ“œğŸ“„ğŸ“°ğŸ—ğŸ“‘ğŸ”–ğŸ·ğŸ’°ğŸ’¸ğŸ’³âœ‰ğŸ“§ğŸ“¨' \
    'ğŸ“©ğŸ“¤ğŸ“¥ğŸ“¦ğŸ“«ğŸ“ªğŸ“¬ğŸ“­ğŸ“®ğŸ—³âœâœ’ğŸ–‹ğŸ–ŠğŸ–ŒğŸ–ğŸ“ğŸ“‚ğŸ—‚ğŸ“…ğŸ“†ğŸ—’ğŸ—“ğŸ“‡ğŸ“ˆğŸ“‰ğŸ“ŠğŸ“‹ğŸ“ŒğŸ“ğŸ“ğŸ–‡ğŸ“ğŸ“âœ‚ğŸ—ƒğŸ—„ğŸ—‘ğŸ”’ğŸ”“' \
    'ğŸ”ğŸ”ğŸ”‘ğŸ—ğŸ”¨â›âš’ğŸ› ğŸ—¡âš”ğŸ”«ğŸ›¡ğŸ”§ğŸ”©âš™ğŸ—œâš—âš–ğŸ”—â›“ğŸ’‰ğŸ’ŠğŸš¬âš°âš±ğŸ›¢ğŸ”®ğŸš°ğŸğŸš©ğŸ´ğŸ³'


def assign_emoji(chat):
    n = crc32(str(chat.wxid or chat.nick_name).encode()) & 0xffffffff
    return emojis[n % len(emojis)]


def msg_prefix(user):
    # represent avatar
    member_prefix = assign_emoji(user)

    # represent sex
    if user.sex is MALE:
        user_suffix = '\U0001f454'
    elif user.sex is FEMALE:
        user_suffix = '\U0001f380'
    else:
        user_suffix = '\U0001f60e'

    return '{} Â· {} Â· {}'.format(member_prefix, user.name, user_suffix)


def sync_message_in_groups(
        msg, groups, prefix=None, suffix=None,
        raise_for_unsupported=False, run_async=True
):
    """
    å°†æ¶ˆæ¯åŒæ­¥åˆ°å¤šä¸ªå¾®ä¿¡ç¾¤ä¸­

    æ”¯æŒä»¥ä¸‹æ¶ˆæ¯ç±»å‹
        * æ–‡æœ¬ (`TEXT`)
        * è§†é¢‘ï¼ˆ`VIDEO`)
        * æ–‡ä»¶ (`ATTACHMENT`)
        * å›¾ç‰‡/è‡ªå®šä¹‰è¡¨æƒ… (`PICTURE`)

            * ä½†ä¸æ”¯æŒè¡¨æƒ…å•†åº—ä¸­çš„è¡¨æƒ…

        * åç‰‡ (`CARD`)

            * ä»…æ”¯æŒå…¬ä¼—å·åç‰‡

        * åˆ†äº« (`SHARING`)

            * ä¼šè¢«è½¬åŒ–ä¸º `æ ‡é¢˜ + é“¾æ¥` å½¢å¼çš„çº¯æ–‡æœ¬

        * è¯­éŸ³ (`RECORDING`)

            * ä¼šä»¥æ–‡ä»¶æ–¹å¼å‘é€

    :param Message msg: éœ€åŒæ­¥çš„æ¶ˆæ¯å¯¹è±¡
    :param Group groups: éœ€åŒæ­¥çš„ç¾¤åˆ—è¡¨
    :param str prefix:
        * è½¬å‘æ—¶çš„ **å‰ç¼€** æ–‡æœ¬ï¼ŒåŸæ¶ˆæ¯ä¸ºæ–‡æœ¬æ—¶ä¼šè‡ªåŠ¨æ¢è¡Œ
        * è‹¥ä¸è®¾å®šï¼Œåˆ™ä½¿ç”¨é»˜è®¤å‰ç¼€ä½œä¸ºæç¤º
    :param str suffix:
        * è½¬å‘æ—¶çš„ **åç¼€** æ–‡æœ¬ï¼ŒåŸæ¶ˆæ¯ä¸ºæ–‡æœ¬æ—¶ä¼šè‡ªåŠ¨æ¢è¡Œ
        * é»˜è®¤ä¸ºç©º
    :param bool raise_for_unsupported:
        | ä¸º True æ—¶ï¼Œå°†ä¸ºä¸æ”¯æŒçš„æ¶ˆæ¯ç±»å‹æŠ›å‡º `NotImplementedError` å¼‚å¸¸
    :param bool run_async: æ˜¯å¦å¼‚æ­¥æ‰§è¡Œï¼Œä¸º True æ—¶ä¸å µå¡çº¿ç¨‹


    ::

        my_groups = [group1, group2, group3 ...]

        @bot.register(my_groups, except_self=False)
        def sync_my_groups(msg):
            sync_message_in_groups(msg, my_groups)

    """

    def process():
        for group in groups:
            if group == msg.chat:
                continue

            msg.forward(
                chat=group, prefix=prefix, suffix=suffix,
                raise_for_unsupported=raise_for_unsupported
            )

    if prefix is None:

        member = msg.member

        member_prefix = assign_emoji(member)

        if member.sex is MALE:
            member_suffix = '\U0001f454'
        elif member.sex is FEMALE:
            member_suffix = '\U0001f380'
        else:
            member_suffix = '\U0001f60e'

        prefix = '{} Â· {} Â· {}'.format(member_prefix, member.name, member_suffix)

    if run_async:
        Thread(target=process, daemon=True).start()
    else:
        process()
