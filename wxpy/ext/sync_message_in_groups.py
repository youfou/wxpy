# coding: utf-8
from __future__ import unicode_literals

from binascii import crc32

from wxpy.utils import start_new_thread

emojis = \
    'ğŸ˜€ğŸ˜ğŸ˜‚ğŸ¤£ğŸ˜ƒğŸ˜„ğŸ˜…ğŸ˜†ğŸ˜‰ğŸ˜ŠğŸ˜‹ğŸ˜ğŸ˜ğŸ˜˜ğŸ˜—ğŸ˜™ğŸ˜šğŸ™‚ğŸ¤—ğŸ¤”ğŸ˜ğŸ˜‘ğŸ˜¶ğŸ™„ğŸ˜ğŸ˜£ğŸ˜¥ğŸ˜®ğŸ¤ğŸ˜¯' \
    'ğŸ˜ªğŸ˜«ğŸ˜´ğŸ˜ŒğŸ¤“ğŸ˜›ğŸ˜œğŸ˜ğŸ¤¤ğŸ˜’ğŸ˜“ğŸ˜”ğŸ˜•ğŸ™ƒğŸ¤‘ğŸ˜²ğŸ˜‡ğŸ¤ ğŸ¤¡ğŸ¤¥ğŸ˜ºğŸ˜¸ğŸ˜¹ğŸ˜»ğŸ˜¼ğŸ˜½ğŸ™€ğŸ˜¿ğŸ˜¾ğŸ™ˆ' \
    'ğŸ™‰ğŸ™ŠğŸŒ±ğŸŒ²ğŸŒ³ğŸŒ´ğŸŒµğŸŒ¾ğŸŒ¿ğŸ€ğŸğŸ‚ğŸƒğŸ‡ğŸˆğŸ‰ğŸŠğŸ‹ğŸŒğŸğŸğŸğŸ‘ğŸ’ğŸ“ğŸ¥ğŸ…ğŸ¥‘ğŸ†ğŸ¥”' \
    'ğŸ¥•ğŸŒ½ğŸ¥’ğŸ„ğŸ¥œğŸŒ°ğŸğŸ¥ğŸ¥–ğŸ¥ğŸ§€ğŸ–ğŸ—ğŸ¥“ğŸ”ğŸŸğŸ•ğŸŒ­ğŸŒ®ğŸŒ¯ğŸ¥™ğŸ¥šğŸ³ğŸ¥˜ğŸ²ğŸ¥—ğŸ¿ğŸ±ğŸ˜ğŸ™' \
    'ğŸšğŸ›ğŸœğŸğŸ ğŸ¢ğŸ£ğŸ¤ğŸ¥ğŸ¡ğŸ¦ğŸ§ğŸ¨ğŸ©ğŸªğŸ‚ğŸ°ğŸ«ğŸ¬ğŸ­ğŸ®ğŸ¯ğŸ¼ğŸ¥›â˜•ğŸµğŸ¶ğŸ¾ğŸ·ğŸ¸' \
    'ğŸ¹ğŸºğŸ»ğŸ¥‚ğŸ¥ƒğŸ´ğŸ¥„ğŸ”ªğŸºğŸŒğŸŒğŸŒğŸŒğŸ—¾ğŸŒ‹ğŸ—»ğŸ ğŸ¡ğŸ¢ğŸ£ğŸ¤ğŸ¥ğŸ¦ğŸ¨ğŸ©ğŸªğŸ«ğŸ¬ğŸ­ğŸ¯' \
    'ğŸ°ğŸ’’ğŸ—¼ğŸ—½â›ªğŸ•ŒğŸ•ğŸ•‹â›²â›ºğŸŒğŸŒƒğŸŒ„ğŸŒ…ğŸŒ†ğŸŒ‡ğŸŒ‰ğŸŒŒğŸ ğŸ¡ğŸ¢ğŸ’ˆğŸªğŸ­ğŸ¨ğŸ°ğŸš‚ğŸšƒğŸš„ğŸš…' \
    'ğŸš†ğŸš‡ğŸšˆğŸš‰ğŸšŠğŸšğŸšğŸš‹ğŸšŒğŸšğŸšğŸšğŸš‘ğŸš’ğŸš“ğŸš”ğŸš•ğŸš–ğŸš—ğŸš˜ğŸš™ğŸššğŸš›ğŸšœğŸš²ğŸ›´ğŸ›µğŸšâ›½ğŸš¨' \
    'ğŸš¥ğŸš¦ğŸš§âš“â›µğŸ›¶ğŸš¤ğŸš¢ğŸ›«ğŸ›¬ğŸ’ºğŸšğŸšŸğŸš ğŸš¡ğŸš€ğŸšªğŸ›ŒğŸš½ğŸš¿ğŸ›€ğŸ›âŒ›â³âŒšâ°ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”' \
    'ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜ğŸŒ™ğŸŒšğŸŒ›ğŸŒœğŸŒğŸŒâ­ğŸŒŸğŸŒ â›…ğŸŒ€ğŸŒˆğŸŒ‚â˜”âš¡â›„ğŸ”¥ğŸ’§ğŸŒŠğŸƒğŸ„ğŸ†ğŸ‡âœ¨ğŸˆğŸ‰' \
    'ğŸŠğŸ‹ğŸğŸğŸğŸğŸ‘ğŸğŸ«ğŸ†ğŸ…ğŸ¥‡ğŸ¥ˆğŸ¥‰âš½âš¾ğŸ€ğŸğŸˆğŸ‰ğŸ¾ğŸ±ğŸ³ğŸğŸ‘ğŸ’ğŸ“ğŸ¸ğŸ¥ŠğŸ¥‹' \
    'ğŸ¥…ğŸ¯â›³ğŸ£ğŸ½ğŸ¿ğŸ®ğŸ²ğŸƒğŸ´ğŸ”‡ğŸ”ˆğŸ”‰ğŸ”ŠğŸ“¢ğŸ“£ğŸ“¯ğŸ””ğŸ”•ğŸ¼ğŸµğŸ¶ğŸ¤ğŸ§ğŸ“»ğŸ·ğŸ¸ğŸ¹ğŸºğŸ»' \
    'ğŸ¥ğŸ“±ğŸ“²ğŸ“ğŸ“ŸğŸ“ ğŸ”‹ğŸ”ŒğŸ’»ğŸ’½ğŸ’¾ğŸ’¿ğŸ“€ğŸ¥ğŸ¬ğŸ“ºğŸ“·ğŸ“¸ğŸ“¹ğŸ“¼ğŸ”ğŸ”ğŸ”¬ğŸ”­ğŸ“¡ğŸ’¡ğŸ”¦ğŸ“”ğŸ“•ğŸ“–' \
    'ğŸ“—ğŸ“˜ğŸ“™ğŸ“šğŸ““ğŸ“’ğŸ“ƒğŸ“œğŸ“„ğŸ“°ğŸ“‘ğŸ”–ğŸ’°ğŸ’´ğŸ’µğŸ’¶ğŸ’·ğŸ’¸ğŸ’³ğŸ’±ğŸ’²ğŸ“§ğŸ“¨ğŸ“©ğŸ“¤ğŸ“¥ğŸ“¦ğŸ“«ğŸ“ªğŸ“¬' \
    'ğŸ“­ğŸ“®ğŸ“ğŸ’¼ğŸ“ğŸ“‚ğŸ“…ğŸ“†ğŸ“‡ğŸ“‹ğŸ“ŒğŸ“ğŸ“ğŸ“ğŸ“ğŸ”’ğŸ”“ğŸ”ğŸ”ğŸ”‘ğŸ”¨ğŸ”«ğŸ¹ğŸ”§ğŸ”©ğŸ”—ğŸš¬ğŸ—¿ğŸ”®ğŸ›’'


def assign_emoji(chat):
    n = crc32(str(chat.wxid or chat.nick_name).encode()) & 0xffffffff
    return emojis[n % len(emojis)]


def forward_prefix(user):
    # represent for avatar
    avatar_repr = assign_emoji(user)
    return '{} Â· {}'.format(avatar_repr, user.name)


def sync_message_in_groups(
        msg, groups, prefix=None, suffix=None,
        raise_for_unsupported=False, run_async=True
):
    """
    å°†æ¶ˆæ¯åŒæ­¥åˆ°å¤šä¸ªå¾®ä¿¡ç¾¤ä¸­

    æ”¯æŒä»¥ä¸‹æ¶ˆæ¯ç±»å‹
        * æ–‡æœ¬ (`TEXT`)
        * è§†é¢‘ï¼ˆ`VIDEO`)
        * æ–‡ä»¶ (`ATTACHMENT`)
        * å›¾ç‰‡/è‡ªå®šä¹‰è¡¨æƒ… (`PICTURE`)

            * ä½†ä¸æ”¯æŒè¡¨æƒ…å•†åº—ä¸­çš„è¡¨æƒ…

        * åç‰‡ (`CARD`)

            * ä»…æ”¯æŒå…¬ä¼—å·åç‰‡ï¼Œä»¥åŠè‡ªå·±å‘å‡ºçš„ä¸ªäººå·åç‰‡

        * åˆ†äº« (`SHARING`)

            * ä¼šè¢«è½¬åŒ–ä¸º `æ ‡é¢˜ + é“¾æ¥` å½¢å¼çš„çº¯æ–‡æœ¬

        * è¯­éŸ³ (`RECORDING`)

            * ä¼šä»¥æ–‡ä»¶æ–¹å¼å‘é€

        * åœ°å›¾ (`MAP`)
            
            * ä¼šè½¬åŒ–ä¸º `ä½ç½®åç§° + åœ°å›¾é“¾æ¥` å½¢å¼çš„æ–‡æœ¬æ¶ˆæ¯

    :param Message msg: éœ€åŒæ­¥çš„æ¶ˆæ¯å¯¹è±¡
    :param Group groups: éœ€åŒæ­¥çš„ç¾¤åˆ—è¡¨
    :param str prefix:
        * è½¬å‘æ—¶çš„ **å‰ç¼€** æ–‡æœ¬ï¼ŒåŸæ¶ˆæ¯ä¸ºæ–‡æœ¬æ—¶ä¼šè‡ªåŠ¨æ¢è¡Œ
        * è‹¥ä¸è®¾å®šï¼Œåˆ™ä½¿ç”¨é»˜è®¤å‰ç¼€ä½œä¸ºæç¤º
    :param str suffix:
        * è½¬å‘æ—¶çš„ **åç¼€** æ–‡æœ¬ï¼ŒåŸæ¶ˆæ¯ä¸ºæ–‡æœ¬æ—¶ä¼šè‡ªåŠ¨æ¢è¡Œ
        * é»˜è®¤ä¸ºç©º
    :param bool raise_for_unsupported:
        | ä¸º True æ—¶ï¼Œå°†ä¸ºä¸æ”¯æŒçš„æ¶ˆæ¯ç±»å‹æŠ›å‡º `NotImplementedError` å¼‚å¸¸
    :param bool run_async: æ˜¯å¦å¼‚æ­¥æ‰§è¡Œï¼Œä¸º True æ—¶ä¸å µå¡çº¿ç¨‹


    ::

        my_groups = [group1, group2, group3 ...]

        @bot.register(my_groups, except_self=False)
        def sync_my_groups(msg):
            sync_message_in_groups(msg, my_groups)

    """

    def process():
        for group in groups:
            if group == msg.chat:
                continue

            msg.forward(
                chat=group, prefix=prefix, suffix=suffix,
                raise_for_unsupported=raise_for_unsupported
            )

    if not prefix:
        prefix = forward_prefix(msg.member)

    if run_async:
        start_new_thread(process, use_caller_name=True)
    else:
        process()
